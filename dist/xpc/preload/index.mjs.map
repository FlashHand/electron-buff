{"version":3,"sources":["../../../src/xpc/preload/xpc-id.helper.ts","../../../src/xpc/preload/xpcPreload.helper.ts"],"names":[],"mappings":";;;;;AAKA,IAAM,MAAA,GAAS,KAAK,MAAA,EAAO,CAAE,SAAS,EAAE,CAAA,CAAE,KAAA,CAAM,CAAA,EAAG,CAAC,CAAA;AACpD,IAAI,OAAA,GAAU,CAAA;AAEP,IAAM,gBAAgB,MAAc;AACzC,EAAA,OAAO,KAAK,MAAM,CAAA,CAAA,EAAA,CAAK,EAAE,OAAA,EAAS,QAAA,CAAS,EAAE,CAAC,CAAA,CAAA;AAChD,CAAA;;;ACNA,IAAM,YAAA,GAAe,kBAAA;AACrB,IAAM,QAAA,GAAW,cAAA;AACjB,IAAM,UAAA,GAAa,gBAAA;AAKZ,IAAM,WAAA,uBAAkB,GAAA;AAS/B,IAAM,MAAA,GAAS,CAAC,UAAA,EAAoB,OAAA,KAA8B;AAChE,EAAA,WAAA,CAAY,GAAA,CAAI,YAAY,OAAO,CAAA;AAGnC,EAAA,WAAA,CAAY,IAAA,CAAK,YAAA,EAAc,EAAE,UAAA,EAAY,CAAA;AAG7C,EAAA,WAAA,CAAY,EAAA,CAAG,UAAA,EAAY,OAAO,MAAA,EAAQ,OAAA,KAAwB;AAChE,IAAA,IAAI,GAAA,GAAW,IAAA;AACf,IAAA,MAAM,YAAA,GAAe,WAAA,CAAY,GAAA,CAAI,UAAU,CAAA;AAC/C,IAAA,IAAI,YAAA,EAAc;AAChB,MAAA,IAAI;AACF,QAAA,GAAA,GAAM,MAAM,aAAa,OAAO,CAAA;AAAA,MAClC,SAAS,EAAA,EAAI;AACX,QAAA,GAAA,GAAM,IAAA;AAAA,MACR;AAAA,IACF;AAEA,IAAA,WAAA,CAAY,KAAK,UAAA,EAAY;AAAA,MAC3B,IAAI,OAAA,CAAQ,EAAA;AAAA,MACZ,YAAY,OAAA,CAAQ,UAAA;AAAA,MACpB,QAAQ,OAAA,CAAQ,MAAA;AAAA,MAChB;AAAA,KACa,CAAA;AAAA,EACjB,CAAC,CAAA;AACH,CAAA;AAKA,IAAM,YAAA,GAAe,CAAC,UAAA,KAA6B;AACjD,EAAA,WAAA,CAAY,OAAO,UAAU,CAAA;AAC7B,EAAA,WAAA,CAAY,mBAAmB,UAAU,CAAA;AAC3C,CAAA;AAOA,IAAM,IAAA,GAAO,OAAO,UAAA,EAAoB,MAAA,KAA+B;AACrE,EAAA,MAAM,OAAA,GAAsB;AAAA,IAC1B,IAAI,aAAA,EAAc;AAAA,IAClB,UAAA;AAAA,IACA,MAAA;AAAA,IACA,GAAA,EAAK;AAAA,GACP;AAEA,EAAA,OAAO,MAAM,WAAA,CAAY,MAAA,CAAO,QAAA,EAAU,OAAO,CAAA;AACnD,CAAA;AAKA,IAAM,uBAAuB,MAAsB;AACjD,EAAA,OAAO;AAAA,IACL,MAAA,EAAQ,CAAC,UAAA,EAAoB,OAAA,KAAyD;AACpF,MAAA,MAAA,CAAO,YAAY,OAAO,CAAA;AAAA,IAC5B,CAAA;AAAA,IACA,YAAA,EAAc,CAAC,UAAA,KAA6B;AAC1C,MAAA,YAAA,CAAa,UAAU,CAAA;AAAA,IACzB,CAAA;AAAA,IACA,IAAA,EAAM,CAAC,UAAA,EAAoB,MAAA,KAA+B;AACxD,MAAA,OAAO,IAAA,CAAK,YAAY,MAAM,CAAA;AAAA,IAChC;AAAA,GACF;AACF,CAAA;AAGO,IAAM,cAA8B,oBAAA;AAG3C,IAAI,QAAQ,eAAA,EAAiB;AAC3B,EAAA,IAAI;AACF,IAAA,aAAA,CAAc,iBAAA,CAAkB,eAAe,WAAW,CAAA;AAAA,EAC5D,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,0CAA0C,KAAK,CAAA;AAAA,EAC/D;AACF,CAAA,MAAO;AACL,EAAC,WAAmB,WAAA,GAAc,WAAA;AACpC","file":"index.mjs","sourcesContent":["/**\n * High-performance process-unique ID generator for renderer process.\n * Combines a random prefix (per process) with an incrementing counter.\n * Guaranteed unique within a single process lifetime.\n */\nconst prefix = Math.random().toString(36).slice(2, 8);\nlet counter = 0;\n\nexport const generateXpcId = (): string => {\n  return `r-${prefix}-${(++counter).toString(36)}`;\n};\n","import { contextBridge, ipcRenderer } from 'electron';\nimport { XpcPayload, XpcRendererApi } from '../shared/xpc.type';\nimport { generateXpcId } from './xpc-id.helper';\n\nconst XPC_REGISTER = '__xpc_register__';\nconst XPC_EXEC = '__xpc_exec__';\nconst XPC_FINISH = '__xpc_finish__';\n\ntype XpcHandler = (payload: XpcPayload) => Promise<any>;\n\n/** Global handlers map, extracted from XpcRenderer class */\nexport const xpcHandlers = new Map<string, XpcHandler>();\n\nexport type { XpcRendererApi } from '../shared/xpc.type';\n\n/**\n * Register a handleName with the main process and bind a local async handler.\n * When another renderer calls send() with this handleName, xpcCenter will forward\n * the payload to this renderer, the handler executes, and result is sent back via __xpc_finish__.\n */\nconst handle = (handleName: string, handler: XpcHandler): void => {\n  xpcHandlers.set(handleName, handler);\n\n  // Notify main process about this registration\n  ipcRenderer.send(XPC_REGISTER, { handleName });\n\n  // Listen for incoming handleName events forwarded by xpcCenter\n  ipcRenderer.on(handleName, async (_event, payload: XpcPayload) => {\n    let ret: any = null;\n    const localHandler = xpcHandlers.get(handleName);\n    if (localHandler) {\n      try {\n        ret = await localHandler(payload);\n      } catch (_e) {\n        ret = null;\n      }\n    }\n    // Send __xpc_finish__ back to main with result\n    ipcRenderer.send(XPC_FINISH, {\n      id: payload.id,\n      handleName: payload.handleName,\n      params: payload.params,\n      ret,\n    } as XpcPayload);\n  });\n};\n\n/**\n * Remove a registered handler.\n */\nconst removeHandle = (handleName: string): void => {\n  xpcHandlers.delete(handleName);\n  ipcRenderer.removeAllListeners(handleName);\n};\n\n/**\n * Send a message to another renderer (or any registered handler) via main process.\n * Uses ipcRenderer.invoke(__xpc_exec__) which blocks until the target finishes.\n * Returns the ret value from the target handler, or null.\n */\nconst send = async (handleName: string, params?: any): Promise<any> => {\n  const payload: XpcPayload = {\n    id: generateXpcId(),\n    handleName,\n    params,\n    ret: null,\n  };\n\n  return await ipcRenderer.invoke(XPC_EXEC, payload);\n};\n\n/**\n * Returns a contextBridge-safe object for exposeInMainWorld.\n */\nconst createXpcRendererApi = (): XpcRendererApi => {\n  return {\n    handle: (handleName: string, handler: (payload: XpcPayload) => Promise<any>): void => {\n      handle(handleName, handler);\n    },\n    removeHandle: (handleName: string): void => {\n      removeHandle(handleName);\n    },\n    send: (handleName: string, params?: any): Promise<any> => {\n      return send(handleName, params);\n    },\n  };\n};\n\n/** The xpcRenderer API instance */\nexport const xpcRenderer: XpcRendererApi = createXpcRendererApi();\n\n// Auto-expose xpcRenderer to window on import\nif (process.contextIsolated) {\n  try {\n    contextBridge.exposeInMainWorld('xpcRenderer', xpcRenderer);\n  } catch (error) {\n    console.error('[xpcPreload] exposeInMainWorld failed:', error);\n  }\n} else {\n  (globalThis as any).xpcRenderer = xpcRenderer;\n}\n"]}